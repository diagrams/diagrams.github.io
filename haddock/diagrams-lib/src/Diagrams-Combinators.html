<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Diagrams/Combinators.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts      #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE MultiParamTypeClasses #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE Rank2Types            #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE TemplateHaskell       #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies          #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE UndecidableInstances  #-}</span>
<a name="line-7"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-8"></a><span class='hs-comment'>-- |</span>
<a name="line-9"></a><span class='hs-comment'>-- Module      :  Diagrams.Combinators</span>
<a name="line-10"></a><span class='hs-comment'>-- Copyright   :  (c) 2011 diagrams-lib team (see LICENSE)</span>
<a name="line-11"></a><span class='hs-comment'>-- License     :  BSD-style (see LICENSE)</span>
<a name="line-12"></a><span class='hs-comment'>-- Maintainer  :  diagrams-discuss@googlegroups.com</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-comment'>-- Higher-level tools for combining diagrams.</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Diagrams</span><span class='hs-varop'>.</span><span class='hs-conid'>Combinators</span>
<a name="line-19"></a>       <span class='hs-layout'>(</span> <span class='hs-comment'>-- * Unary operations</span>
<a name="line-20"></a>
<a name="line-21"></a>         <span class='hs-varid'>withEnvelope</span><span class='hs-layout'>,</span> <span class='hs-varid'>withTrace</span>
<a name="line-22"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>phantom</span><span class='hs-layout'>,</span> <span class='hs-varid'>strut</span>
<a name="line-23"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>pad</span><span class='hs-layout'>,</span> <span class='hs-varid'>frame</span>
<a name="line-24"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>extrudeEnvelope</span><span class='hs-layout'>,</span> <span class='hs-varid'>intrudeEnvelope</span>
<a name="line-25"></a>
<a name="line-26"></a>         <span class='hs-comment'>-- * Binary operations</span>
<a name="line-27"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>atop</span>
<a name="line-28"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>beneath</span>
<a name="line-29"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>beside</span>
<a name="line-30"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>atDirection</span>
<a name="line-31"></a>
<a name="line-32"></a>         <span class='hs-comment'>-- * n-ary operations</span>
<a name="line-33"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>appends</span>
<a name="line-34"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>position</span><span class='hs-layout'>,</span> <span class='hs-varid'>atPoints</span>
<a name="line-35"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>cat</span><span class='hs-layout'>,</span> <span class='hs-varid'>cat'</span>
<a name="line-36"></a>       <span class='hs-layout'>,</span> <span class='hs-conid'>CatOpts</span><span class='hs-layout'>(</span><span class='hs-sel'>_catMethod</span><span class='hs-layout'>,</span> <span class='hs-sel'>_sep</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>catMethod</span><span class='hs-layout'>,</span> <span class='hs-varid'>sep</span>
<a name="line-37"></a>       <span class='hs-layout'>,</span> <span class='hs-conid'>CatMethod</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-38"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>composeAligned</span>
<a name="line-39"></a>
<a name="line-40"></a>       <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Lens</span>          <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>beside</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span> <span class='hs-cpp'>#</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Default</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-44"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>            <span class='hs-layout'>(</span><span class='hs-varid'>fromJust</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Monoid</span><span class='hs-varop'>.</span><span class='hs-conid'>Deletable</span> <span class='hs-layout'>(</span><span class='hs-varid'>toDeletable</span><span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Monoid</span><span class='hs-varop'>.</span><span class='hs-conid'>MList</span>     <span class='hs-layout'>(</span><span class='hs-varid'>inj</span><span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Proxy</span>
<a name="line-48"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Semigroup</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Tree</span><span class='hs-varop'>.</span><span class='hs-conid'>DUAL</span>        <span class='hs-keyword'>as</span> <span class='hs-conid'>D</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Diagrams</span><span class='hs-varop'>.</span><span class='hs-conid'>Core</span>
<a name="line-52"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Diagrams</span><span class='hs-varop'>.</span><span class='hs-conid'>Core</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>   <span class='hs-layout'>(</span><span class='hs-conid'>QDiagram</span> <span class='hs-layout'>(</span><span class='hs-conid'>QD</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Diagrams</span><span class='hs-varop'>.</span><span class='hs-conid'>Direction</span>
<a name="line-54"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Diagrams</span><span class='hs-varop'>.</span><span class='hs-conid'>Names</span>        <span class='hs-layout'>(</span><span class='hs-varid'>named</span><span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Diagrams</span><span class='hs-varop'>.</span><span class='hs-conid'>Segment</span>      <span class='hs-layout'>(</span><span class='hs-varid'>straight</span><span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Diagrams</span><span class='hs-varop'>.</span><span class='hs-conid'>Util</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Linear</span><span class='hs-varop'>.</span><span class='hs-conid'>Affine</span>
<a name="line-59"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Linear</span><span class='hs-varop'>.</span><span class='hs-conid'>Metric</span>
<a name="line-60"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Linear</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-63"></a><span class='hs-comment'>-- Working with envelopes</span>
<a name="line-64"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="withEnvelope"></a><span class='hs-comment'>-- | Use the envelope from some object as the envelope for a</span>
<a name="line-67"></a><span class='hs-comment'>--   diagram, in place of the diagram's default envelope.</span>
<a name="line-68"></a><span class='hs-comment'>--</span>
<a name="line-69"></a><span class='hs-comment'>--   &lt;&lt;diagrams/src_Diagrams_Combinators_withEnvelopeEx.svg#diagram=withEnvelopeEx&amp;width=300&gt;&gt;</span>
<a name="line-70"></a><span class='hs-comment'>--</span>
<a name="line-71"></a><span class='hs-comment'>--   &gt; sqNewEnv =</span>
<a name="line-72"></a><span class='hs-comment'>--   &gt;     circle 1 # fc green</span>
<a name="line-73"></a><span class='hs-comment'>--   &gt;     |||</span>
<a name="line-74"></a><span class='hs-comment'>--   &gt;     (    c # dashingG [0.1,0.1] 0 # lc white</span>
<a name="line-75"></a><span class='hs-comment'>--   &gt;       &lt;&gt; square 2 # withEnvelope (c :: D V2 Double) # fc blue</span>
<a name="line-76"></a><span class='hs-comment'>--   &gt;     )</span>
<a name="line-77"></a><span class='hs-comment'>--   &gt; c = circle 0.8</span>
<a name="line-78"></a><span class='hs-comment'>--   &gt; withEnvelopeEx = sqNewEnv # centerXY # pad 1.5</span>
<a name="line-79"></a><span class='hs-definition'>withEnvelope</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InSpace</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Enveloped</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-80"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-81"></a><span class='hs-definition'>withEnvelope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setEnvelope</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getEnvelope</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="withTrace"></a><span class='hs-comment'>-- | Use the trace from some object as the trace for a diagram, in</span>
<a name="line-84"></a><span class='hs-comment'>--   place of the diagram's default trace.</span>
<a name="line-85"></a><span class='hs-definition'>withTrace</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InSpace</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrderedField</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Traced</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-86"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-87"></a><span class='hs-definition'>withTrace</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTrace</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getTrace</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="phantom"></a><span class='hs-comment'>-- | @phantom x@ produces a \"phantom\" diagram, which has the same</span>
<a name="line-90"></a><span class='hs-comment'>--   envelope and trace as @x@ but produces no output.</span>
<a name="line-91"></a><span class='hs-definition'>phantom</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InSpace</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Enveloped</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Traced</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-92"></a><span class='hs-definition'>phantom</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>QD</span> <span class='hs-varop'>$</span> <span class='hs-conid'>D</span><span class='hs-varop'>.</span><span class='hs-varid'>leafU</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>inj</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toDeletable</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getEnvelope</span> <span class='hs-varop'>$</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>inj</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toDeletable</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getTrace</span> <span class='hs-varop'>$</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="pad"></a><span class='hs-comment'>-- | @pad s@ \"pads\" a diagram, expanding its envelope by a factor of</span>
<a name="line-95"></a><span class='hs-comment'>--   @s@ (factors between 0 and 1 can be used to shrink the envelope).</span>
<a name="line-96"></a><span class='hs-comment'>--   Note that the envelope will expand with respect to the local</span>
<a name="line-97"></a><span class='hs-comment'>--   origin, so if the origin is not centered the padding may appear</span>
<a name="line-98"></a><span class='hs-comment'>--   \"uneven\".  If this is not desired, the origin can be centered</span>
<a name="line-99"></a><span class='hs-comment'>--   (using, e.g., 'centerXY' for 2D diagrams) before applying @pad@.</span>
<a name="line-100"></a><span class='hs-definition'>pad</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrderedField</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-101"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-102"></a><span class='hs-definition'>pad</span> <span class='hs-varid'>s</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withEnvelope</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span> <span class='hs-cpp'>#</span> <span class='hs-varid'>scale</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>d</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="frame"></a><span class='hs-comment'>-- | @frame s@ increases the envelope of a diagram by and absolute amount @s@,</span>
<a name="line-105"></a><span class='hs-comment'>--   s is in the local units of the diagram. This function is similar to @pad@,</span>
<a name="line-106"></a><span class='hs-comment'>--   only it takes an absolute quantity and pre-centering should not be</span>
<a name="line-107"></a><span class='hs-comment'>--   necessary.</span>
<a name="line-108"></a><span class='hs-definition'>frame</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrderedField</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-109"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-110"></a><span class='hs-definition'>frame</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>over</span> <span class='hs-varid'>envelope</span> <span class='hs-layout'>(</span><span class='hs-varid'>onEnvelope</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-varop'>+</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="strut"></a><span class='hs-comment'>-- | @strut v@ is a diagram which produces no output, but with respect</span>
<a name="line-113"></a><span class='hs-comment'>--   to alignment and envelope acts like a 1-dimensional segment</span>
<a name="line-114"></a><span class='hs-comment'>--   oriented along the vector @v@, with local origin at its</span>
<a name="line-115"></a><span class='hs-comment'>--   center. (Note, however, that it has an empty trace; for 2D struts</span>
<a name="line-116"></a><span class='hs-comment'>--   with a nonempty trace see 'strutR2', 'strutX', and 'strutY' from</span>
<a name="line-117"></a><span class='hs-comment'>--   "Diagrams.TwoD.Combinators".) Useful for manually creating</span>
<a name="line-118"></a><span class='hs-comment'>--   separation between two diagrams.</span>
<a name="line-119"></a><span class='hs-comment'>--</span>
<a name="line-120"></a><span class='hs-comment'>--   &lt;&lt;diagrams/src_Diagrams_Combinators_strutEx.svg#diagram=strutEx&amp;width=300&gt;&gt;</span>
<a name="line-121"></a><span class='hs-comment'>--</span>
<a name="line-122"></a><span class='hs-comment'>--   &gt; strutEx = (circle 1 ||| strut unitX ||| circle 1) # centerXY # pad 1.1</span>
<a name="line-123"></a><span class='hs-definition'>strut</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrderedField</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-124"></a>      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-125"></a><span class='hs-definition'>strut</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>QD</span> <span class='hs-varop'>$</span> <span class='hs-conid'>D</span><span class='hs-varop'>.</span><span class='hs-varid'>leafU</span> <span class='hs-layout'>(</span><span class='hs-varid'>inj</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toDeletable</span> <span class='hs-varop'>$</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-126"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>translate</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>0.5</span><span class='hs-layout'>)</span> <span class='hs-varop'>*^</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getEnvelope</span> <span class='hs-varop'>$</span> <span class='hs-varid'>straight</span> <span class='hs-varid'>v</span>
<a name="line-127"></a>  <span class='hs-comment'>-- note we can't use 'phantom' here because it tries to construct a</span>
<a name="line-128"></a>  <span class='hs-comment'>-- trace as well, and segments do not have a trace in general (only</span>
<a name="line-129"></a>  <span class='hs-comment'>-- in 2D; see Diagrams.TwoD.Segment).  This is a good reason to have</span>
<a name="line-130"></a>  <span class='hs-comment'>-- a special 'strut' combinator (before the introduction of traces</span>
<a name="line-131"></a>  <span class='hs-comment'>-- it was mostly just for convenience).</span>
<a name="line-132"></a>  <span class='hs-comment'>--</span>
<a name="line-133"></a>  <span class='hs-comment'>-- also note that we can't remove the call to getEnvelope, since</span>
<a name="line-134"></a>  <span class='hs-comment'>-- translating a segment has no effect.</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="extrudeEnvelope"></a><span class='hs-comment'>-- | @extrudeEnvelope v d@ asymmetrically \"extrudes\" the envelope of</span>
<a name="line-137"></a><span class='hs-comment'>--   a diagram in the given direction.  All parts of the envelope</span>
<a name="line-138"></a><span class='hs-comment'>--   within 90 degrees of this direction are modified, offset outwards</span>
<a name="line-139"></a><span class='hs-comment'>--   by the magnitude of the vector.</span>
<a name="line-140"></a><span class='hs-comment'>--</span>
<a name="line-141"></a><span class='hs-comment'>--   This works by offsetting the envelope distance proportionally to</span>
<a name="line-142"></a><span class='hs-comment'>--   the cosine of the difference in angle, and leaving it unchanged</span>
<a name="line-143"></a><span class='hs-comment'>--   when this factor is negative.</span>
<a name="line-144"></a><span class='hs-definition'>extrudeEnvelope</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrderedField</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-147"></a><span class='hs-definition'>extrudeEnvelope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deformEnvelope</span> <span class='hs-num'>0.5</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="intrudeEnvelope"></a><span class='hs-comment'>-- | @intrudeEnvelope v d@ asymmetrically \"intrudes\" the envelope of</span>
<a name="line-150"></a><span class='hs-comment'>--   a diagram away from the given direction.  All parts of the envelope</span>
<a name="line-151"></a><span class='hs-comment'>--   within 90 degrees of this direction are modified, offset inwards</span>
<a name="line-152"></a><span class='hs-comment'>--   by the magnitude of the vector.</span>
<a name="line-153"></a><span class='hs-comment'>--</span>
<a name="line-154"></a><span class='hs-comment'>--   Note that this could create strange inverted envelopes, where</span>
<a name="line-155"></a><span class='hs-comment'>--   @ diameter v d &lt; 0 @.</span>
<a name="line-156"></a><span class='hs-definition'>intrudeEnvelope</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrderedField</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-158"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-159"></a><span class='hs-definition'>intrudeEnvelope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deformEnvelope</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>0.5</span><span class='hs-layout'>)</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="deformEnvelope"></a><span class='hs-comment'>-- Utility for extrudeEnvelope / intrudeEnvelope</span>
<a name="line-162"></a><span class='hs-definition'>deformEnvelope</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrderedField</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-164"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-165"></a><span class='hs-definition'>deformEnvelope</span> <span class='hs-varid'>s</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>over</span> <span class='hs-layout'>(</span><span class='hs-varid'>envelope</span> <span class='hs-varop'>.</span> <span class='hs-sel'>_Wrapping</span> <span class='hs-conid'>Envelope</span><span class='hs-layout'>)</span> <span class='hs-varid'>deformE</span>
<a name="line-166"></a>  <span class='hs-keyword'>where</span>
<a name="line-167"></a>    <span class='hs-varid'>deformE</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Option</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>deformE'</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getOption</span>
<a name="line-168"></a>    <span class='hs-varid'>deformE'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v'</span>
<a name="line-169"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dp</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Max</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getMax</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-varid'>dp</span> <span class='hs-varop'>*</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varop'>/</span> <span class='hs-varid'>norm</span> <span class='hs-varid'>v'</span>
<a name="line-170"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v'</span>
<a name="line-171"></a>      <span class='hs-keyword'>where</span>
<a name="line-172"></a>        <span class='hs-varid'>dp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v'</span> <span class='hs-varop'>`dot`</span> <span class='hs-varid'>v</span>
<a name="line-173"></a>
<a name="line-174"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-175"></a><span class='hs-comment'>-- Combining two objects</span>
<a name="line-176"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="beneath"></a><span class='hs-comment'>-- | @beneath@ is just a convenient synonym for @'flip' 'atop'@; that is,</span>
<a name="line-179"></a><span class='hs-comment'>--   @d1 \`beneath\` d2@ is the diagram with @d2@ superimposed on top of</span>
<a name="line-180"></a><span class='hs-comment'>--   @d1@.</span>
<a name="line-181"></a><span class='hs-definition'>beneath</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>OrderedField</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-182"></a>     <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-183"></a><span class='hs-definition'>beneath</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>atop</span>
<a name="line-184"></a>
<a name="line-185"></a><span class='hs-keyword'>infixl</span> <span class='hs-num'>6</span> <span class='hs-varop'>`beneath`</span>
<a name="line-186"></a>
<a name="line-187"></a><a name="beside"></a><span class='hs-comment'>-- | Place two monoidal objects (/i.e./ diagrams, paths,</span>
<a name="line-188"></a><span class='hs-comment'>--   animations...) next to each other along the given vector.  In</span>
<a name="line-189"></a><span class='hs-comment'>--   particular, place the second object so that the vector points</span>
<a name="line-190"></a><span class='hs-comment'>--   from the local origin of the first object to the local origin of</span>
<a name="line-191"></a><span class='hs-comment'>--   the second object, at a distance so that their envelopes are just</span>
<a name="line-192"></a><span class='hs-comment'>--   tangent.  The local origin of the new, combined object is the</span>
<a name="line-193"></a><span class='hs-comment'>--   local origin of the first object (unless the first object is the</span>
<a name="line-194"></a><span class='hs-comment'>--   identity element, in which case the second object is returned</span>
<a name="line-195"></a><span class='hs-comment'>--   unchanged).</span>
<a name="line-196"></a><span class='hs-comment'>--</span>
<a name="line-197"></a><span class='hs-comment'>--   &lt;&lt;diagrams/src_Diagrams_Combinators_besideEx.svg#diagram=besideEx&amp;height=200&gt;&gt;</span>
<a name="line-198"></a><span class='hs-comment'>--</span>
<a name="line-199"></a><span class='hs-comment'>--   &gt; besideEx = beside (r2 (20,30))</span>
<a name="line-200"></a><span class='hs-comment'>--   &gt;                   (circle 1 # fc orange)</span>
<a name="line-201"></a><span class='hs-comment'>--   &gt;                   (circle 1.5 # fc purple)</span>
<a name="line-202"></a><span class='hs-comment'>--   &gt;            # showOrigin</span>
<a name="line-203"></a><span class='hs-comment'>--   &gt;            # centerXY # pad 1.1</span>
<a name="line-204"></a><span class='hs-comment'>--</span>
<a name="line-205"></a><span class='hs-comment'>--   Note that @beside v@ is associative, so objects under @beside v@</span>
<a name="line-206"></a><span class='hs-comment'>--   form a semigroup for any given vector @v@.  In fact, they also</span>
<a name="line-207"></a><span class='hs-comment'>--   form a monoid: 'mempty' is clearly a right identity (@beside v d1</span>
<a name="line-208"></a><span class='hs-comment'>--   mempty === d1@), and there should also be a special case to make</span>
<a name="line-209"></a><span class='hs-comment'>--   it a left identity, as described above.</span>
<a name="line-210"></a><span class='hs-comment'>--</span>
<a name="line-211"></a><span class='hs-comment'>--   In older versions of diagrams, @beside@ put the local origin of</span>
<a name="line-212"></a><span class='hs-comment'>--   the result at the point of tangency between the two inputs.  That</span>
<a name="line-213"></a><span class='hs-comment'>--   semantics can easily be recovered by performing an alignment on</span>
<a name="line-214"></a><span class='hs-comment'>--   the first input before combining.  That is, if @beside'@ denotes</span>
<a name="line-215"></a><span class='hs-comment'>--   the old semantics,</span>
<a name="line-216"></a><span class='hs-comment'>--</span>
<a name="line-217"></a><span class='hs-comment'>--   &gt; beside' v x1 x2 = beside v (x1 # align v) x2</span>
<a name="line-218"></a><span class='hs-comment'>--</span>
<a name="line-219"></a><span class='hs-comment'>--   To get something like @beside v x1 x2@ whose local origin is</span>
<a name="line-220"></a><span class='hs-comment'>--   identified with that of @x2@ instead of @x1@, use @beside</span>
<a name="line-221"></a><span class='hs-comment'>--   (negateV v) x2 x1@.</span>
<a name="line-222"></a><span class='hs-definition'>beside</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Juxtaposable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Vn</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-223"></a><span class='hs-definition'>beside</span> <span class='hs-varid'>v</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>juxtapose</span> <span class='hs-varid'>v</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d2</span>
<a name="line-224"></a>
<a name="line-225"></a><a name="atDirection"></a><span class='hs-comment'>-- | Place two diagrams (or other juxtaposable objects) adjacent to</span>
<a name="line-226"></a><span class='hs-comment'>--   one another, with the second diagram placed in the direction 'd'</span>
<a name="line-227"></a><span class='hs-comment'>--   from the first.  The local origin of the resulting combined</span>
<a name="line-228"></a><span class='hs-comment'>--   diagram is the same as the local origin of the first.  See the</span>
<a name="line-229"></a><span class='hs-comment'>--   documentation of 'beside' for more information.</span>
<a name="line-230"></a><span class='hs-definition'>atDirection</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InSpace</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>Floating</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Juxtaposable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-231"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Direction</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-232"></a><span class='hs-definition'>atDirection</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>beside</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromDirection</span>
<a name="line-233"></a>
<a name="line-234"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-235"></a><span class='hs-comment'>-- Combining multiple objects</span>
<a name="line-236"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-237"></a>
<a name="line-238"></a><a name="appends"></a><span class='hs-comment'>-- | @appends x ys@ appends each of the objects in @ys@ to the object</span>
<a name="line-239"></a><span class='hs-comment'>--   @x@ in the corresponding direction.  Note that each object in</span>
<a name="line-240"></a><span class='hs-comment'>--   @ys@ is positioned beside @x@ /without/ reference to the other</span>
<a name="line-241"></a><span class='hs-comment'>--   objects in @ys@, so this is not the same as iterating 'beside'.</span>
<a name="line-242"></a><span class='hs-comment'>--</span>
<a name="line-243"></a><span class='hs-comment'>--   &lt;&lt;diagrams/src_Diagrams_Combinators_appendsEx.svg#diagram=appendsEx&amp;width=200&gt;&gt;</span>
<a name="line-244"></a><span class='hs-comment'>--</span>
<a name="line-245"></a><span class='hs-comment'>--   &gt; appendsEx = appends c (zip (iterateN 6 (rotateBy (1/6)) unitX) (repeat c))</span>
<a name="line-246"></a><span class='hs-comment'>--   &gt;             # centerXY # pad 1.1</span>
<a name="line-247"></a><span class='hs-comment'>--   &gt;   where c = circle 1</span>
<a name="line-248"></a><span class='hs-definition'>appends</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Juxtaposable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Vn</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-249"></a><span class='hs-definition'>appends</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>apps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>mconcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>juxtapose</span> <span class='hs-varid'>v</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varid'>apps</span><span class='hs-layout'>)</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="position"></a><span class='hs-comment'>-- | Position things absolutely: combine a list of objects</span>
<a name="line-252"></a><span class='hs-comment'>--   (e.g. diagrams or paths) by assigning them absolute positions in</span>
<a name="line-253"></a><span class='hs-comment'>--   the vector space of the combined object.</span>
<a name="line-254"></a><span class='hs-comment'>--</span>
<a name="line-255"></a><span class='hs-comment'>--   &lt;&lt;diagrams/src_Diagrams_Combinators_positionEx.svg#diagram=positionEx&amp;height=300&gt;&gt;</span>
<a name="line-256"></a><span class='hs-comment'>--</span>
<a name="line-257"></a><span class='hs-comment'>--   &gt; positionEx = position (zip (map mkPoint [-3, -2.8 .. 3]) (repeat spot))</span>
<a name="line-258"></a><span class='hs-comment'>--   &gt;   where spot      = circle 0.2 # fc black</span>
<a name="line-259"></a><span class='hs-comment'>--   &gt;         mkPoint :: Double -&gt; P2 Double</span>
<a name="line-260"></a><span class='hs-comment'>--   &gt;         mkPoint x = p2 (x,x*x)</span>
<a name="line-261"></a><span class='hs-definition'>position</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InSpace</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>HasOrigin</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Point</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-262"></a><span class='hs-definition'>position</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mconcat</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>moveTo</span><span class='hs-layout'>)</span>
<a name="line-263"></a>
<a name="line-264"></a><a name="atPoints"></a><span class='hs-comment'>-- | Curried version of @position@, takes a list of points and a list of</span>
<a name="line-265"></a><span class='hs-comment'>--   objects.</span>
<a name="line-266"></a><span class='hs-definition'>atPoints</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InSpace</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>HasOrigin</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Point</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-267"></a><span class='hs-definition'>atPoints</span> <span class='hs-varid'>ps</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>position</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>ps</span> <span class='hs-keyword'>as</span>
<a name="line-268"></a>
<a name="line-269"></a><a name="CatMethod"></a><span class='hs-comment'>-- | Methods for concatenating diagrams.</span>
<a name="line-270"></a><a name="CatMethod"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CatMethod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cat</span>     <span class='hs-comment'>-- ^ Normal catenation: simply put diagrams</span>
<a name="line-271"></a>                         <span class='hs-comment'>--   next to one another (possibly with a</span>
<a name="line-272"></a>                         <span class='hs-comment'>--   certain distance in between each). The</span>
<a name="line-273"></a>                         <span class='hs-comment'>--   distance between successive diagram</span>
<a name="line-274"></a>                         <span class='hs-comment'>--   /envelopes/ will be consistent; the</span>
<a name="line-275"></a>                         <span class='hs-comment'>--   distance between /origins/ may vary if</span>
<a name="line-276"></a>                         <span class='hs-comment'>--   the diagrams are of different sizes.</span>
<a name="line-277"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Distrib</span> <span class='hs-comment'>-- ^ Distribution: place the local origins of</span>
<a name="line-278"></a>                         <span class='hs-comment'>--   diagrams at regular intervals.  With</span>
<a name="line-279"></a>                         <span class='hs-comment'>--   this method, the distance between</span>
<a name="line-280"></a>                         <span class='hs-comment'>--   successive /origins/ will be consistent</span>
<a name="line-281"></a>                         <span class='hs-comment'>--   but the distance between envelopes may</span>
<a name="line-282"></a>                         <span class='hs-comment'>--   not be.  Indeed, depending on the amount</span>
<a name="line-283"></a>                         <span class='hs-comment'>--   of separation, diagrams may overlap.</span>
<a name="line-284"></a>
<a name="line-285"></a><a name="CatOpts"></a><span class='hs-comment'>-- | Options for 'cat''.</span>
<a name="line-286"></a><a name="CatOpts"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CatOpts</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CatOpts</span> <span class='hs-layout'>{</span> <span class='hs-sel'>_catMethod</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CatMethod</span>
<a name="line-287"></a>                         <span class='hs-layout'>,</span> <span class='hs-sel'>_sep</span>          <span class='hs-keyglyph'>::</span> <span class='hs-varid'>n</span>
<a name="line-288"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>catOptsvProxy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Proxy</span> <span class='hs-varid'>n</span>
<a name="line-289"></a>                         <span class='hs-layout'>}</span>
<a name="line-290"></a>
<a name="line-291"></a><span class='hs-comment'>-- The reason the proxy field is necessary is that without it,</span>
<a name="line-292"></a><span class='hs-comment'>-- altering the sep field could theoretically change the type of a</span>
<a name="line-293"></a><span class='hs-comment'>-- CatOpts record.  This causes problems when using record update, as</span>
<a name="line-294"></a><span class='hs-comment'>-- in @with { _sep = 10 }@, because knowing the type of the whole</span>
<a name="line-295"></a><span class='hs-comment'>-- expression does not tell us anything about the type of @with@, and</span>
<a name="line-296"></a><span class='hs-comment'>-- therefore the @Num (Scalar v)@ constraint cannot be satisfied.</span>
<a name="line-297"></a><span class='hs-comment'>-- Adding the Proxy field constrains the type of @with@ in @with {_sep</span>
<a name="line-298"></a><span class='hs-comment'>-- = 10}@ to be the same as the type of the whole expression.  Note</span>
<a name="line-299"></a><span class='hs-comment'>-- this is not a problem when using the 'sep' lens, as its type is</span>
<a name="line-300"></a><span class='hs-comment'>-- more restricted.</span>
<a name="line-301"></a>
<a name="line-302"></a><a name="makeLensesWith"></a><span class='hs-definition'>makeLensesWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>lensRules</span> <span class='hs-varop'>&amp;</span> <span class='hs-varid'>generateSignatures</span> <span class='hs-varop'>.~</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-chr'>'</span><span class='hs-chr'>'</span><span class='hs-conid'>CatOpts</span>
<a name="line-303"></a>
<a name="line-304"></a><a name="catMethod"></a><span class='hs-comment'>-- | Which 'CatMethod' should be used:</span>
<a name="line-305"></a><span class='hs-comment'>--   normal catenation (default), or distribution?</span>
<a name="line-306"></a><span class='hs-definition'>catMethod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Lens'</span> <span class='hs-layout'>(</span><span class='hs-conid'>CatOpts</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-conid'>CatMethod</span>
<a name="line-307"></a>
<a name="line-308"></a><a name="sep"></a><span class='hs-comment'>-- | How much separation should be used between successive diagrams</span>
<a name="line-309"></a><span class='hs-comment'>--   (default: 0)?  When @catMethod = Cat@, this is the distance between</span>
<a name="line-310"></a><span class='hs-comment'>--   /envelopes/; when @catMethod = Distrib@, this is the distance</span>
<a name="line-311"></a><span class='hs-comment'>--   between /origins/.</span>
<a name="line-312"></a><span class='hs-definition'>sep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Lens'</span> <span class='hs-layout'>(</span><span class='hs-conid'>CatOpts</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-313"></a>
<a name="line-314"></a><a name="instance%20Default%20(CatOpts%20n)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Default</span> <span class='hs-layout'>(</span><span class='hs-conid'>CatOpts</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-315"></a>  <span class='hs-varid'>def</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CatOpts</span> <span class='hs-layout'>{</span> <span class='hs-sel'>_catMethod</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cat</span>
<a name="line-316"></a>                <span class='hs-layout'>,</span> <span class='hs-sel'>_sep</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-317"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>catOptsvProxy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Proxy</span>
<a name="line-318"></a>                <span class='hs-layout'>}</span>
<a name="line-319"></a>
<a name="line-320"></a><a name="cat"></a><span class='hs-comment'>-- | @cat v@ positions a list of objects so that their local origins</span>
<a name="line-321"></a><span class='hs-comment'>--   lie along a line in the direction of @v@.  Successive objects</span>
<a name="line-322"></a><span class='hs-comment'>--   will have their envelopes just touching.  The local origin</span>
<a name="line-323"></a><span class='hs-comment'>--   of the result will be the same as the local origin of the first</span>
<a name="line-324"></a><span class='hs-comment'>--   object.</span>
<a name="line-325"></a><span class='hs-comment'>--</span>
<a name="line-326"></a><span class='hs-comment'>--   See also 'cat'', which takes an extra options record allowing</span>
<a name="line-327"></a><span class='hs-comment'>--   certain aspects of the operation to be tweaked.</span>
<a name="line-328"></a><span class='hs-definition'>cat</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InSpace</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>Floating</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Juxtaposable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>HasOrigin</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-329"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-330"></a><span class='hs-definition'>cat</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cat'</span> <span class='hs-varid'>v</span> <span class='hs-varid'>def</span>
<a name="line-331"></a>
<a name="line-332"></a><a name="cat'"></a><span class='hs-comment'>-- | Like 'cat', but taking an extra 'CatOpts' arguments allowing the</span>
<a name="line-333"></a><span class='hs-comment'>--   user to specify</span>
<a name="line-334"></a><span class='hs-comment'>--</span>
<a name="line-335"></a><span class='hs-comment'>--   * The spacing method: catenation (uniform spacing between</span>
<a name="line-336"></a><span class='hs-comment'>--     envelopes) or distribution (uniform spacing between local</span>
<a name="line-337"></a><span class='hs-comment'>--     origins).  The default is catenation.</span>
<a name="line-338"></a><span class='hs-comment'>--</span>
<a name="line-339"></a><span class='hs-comment'>--   * The amount of separation between successive diagram</span>
<a name="line-340"></a><span class='hs-comment'>--     envelopes/origins (depending on the spacing method).  The</span>
<a name="line-341"></a><span class='hs-comment'>--     default is 0.</span>
<a name="line-342"></a><span class='hs-comment'>--</span>
<a name="line-343"></a><span class='hs-comment'>--   'CatOpts' is an instance of 'Default', so 'with' may be used for</span>
<a name="line-344"></a><span class='hs-comment'>--   the second argument, as in @cat' (1,2) (with &amp; sep .~ 2)@.</span>
<a name="line-345"></a><span class='hs-comment'>--</span>
<a name="line-346"></a><span class='hs-comment'>--   Note that @cat' v (with &amp; catMethod .~ Distrib) === mconcat@</span>
<a name="line-347"></a><span class='hs-comment'>--   (distributing with a separation of 0 is the same as</span>
<a name="line-348"></a><span class='hs-comment'>--   superimposing).</span>
<a name="line-349"></a><span class='hs-definition'>cat'</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InSpace</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>Floating</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Juxtaposable</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid'</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>HasOrigin</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-350"></a>     <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CatOpts</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-351"></a><span class='hs-definition'>cat'</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>CatOpts</span> <span class='hs-layout'>{</span> <span class='hs-sel'>_catMethod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cat</span><span class='hs-layout'>,</span> <span class='hs-sel'>_sep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldB</span> <span class='hs-varid'>comb</span> <span class='hs-varid'>mempty</span>
<a name="line-352"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>comb</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>juxtapose</span> <span class='hs-varid'>v</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d2</span> <span class='hs-cpp'>#</span> <span class='hs-varid'>moveOriginBy</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-353"></a>        <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> <span class='hs-varop'>*^</span> <span class='hs-varid'>signorm</span> <span class='hs-layout'>(</span><span class='hs-varid'>negated</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-354"></a>
<a name="line-355"></a><span class='hs-definition'>cat'</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>CatOpts</span> <span class='hs-layout'>{</span> <span class='hs-sel'>_catMethod</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Distrib</span><span class='hs-layout'>,</span> <span class='hs-sel'>_sep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-356"></a>  <span class='hs-varid'>position</span> <span class='hs-varop'>.</span> <span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>iterate</span> <span class='hs-layout'>(</span><span class='hs-varop'>.+^</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>*^</span> <span class='hs-varid'>signorm</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span>
<a name="line-357"></a>
<a name="line-358"></a><a name="composeAligned"></a><span class='hs-comment'>-- | Compose a list of diagrams using the given composition function,</span>
<a name="line-359"></a><span class='hs-comment'>--   first aligning them all according to the given alignment, /but/</span>
<a name="line-360"></a><span class='hs-comment'>--   retain the local origin of the first diagram, as it would be if</span>
<a name="line-361"></a><span class='hs-comment'>--   the composition function were applied directly.  That is,</span>
<a name="line-362"></a><span class='hs-comment'>--   @composeAligned algn comp@ is equivalent to @translate v . comp</span>
<a name="line-363"></a><span class='hs-comment'>--   . map algn@ for some appropriate translation vector @v@.</span>
<a name="line-364"></a><span class='hs-comment'>--</span>
<a name="line-365"></a><span class='hs-comment'>--   Unfortunately, this only works for diagrams (and not, say, paths)</span>
<a name="line-366"></a><span class='hs-comment'>--   because there is no most general type for alignment functions,</span>
<a name="line-367"></a><span class='hs-comment'>--   and no generic way to find out what an alignment function does to</span>
<a name="line-368"></a><span class='hs-comment'>--   the origin of things.  (However, it should be possible to make a</span>
<a name="line-369"></a><span class='hs-comment'>--   version of this function that works /specifically/ on paths, if</span>
<a name="line-370"></a><span class='hs-comment'>--   such a thing were deemed useful.)</span>
<a name="line-371"></a><span class='hs-comment'>--</span>
<a name="line-372"></a><span class='hs-comment'>--   &lt;&lt;diagrams/src_Diagrams_Combinators_alignedEx1.svg#diagram=alignedEx1&amp;width=400&gt;&gt;</span>
<a name="line-373"></a><span class='hs-comment'>--</span>
<a name="line-374"></a><span class='hs-comment'>--   &gt; alignedEx1 = (hsep 2 # composeAligned alignT) (map circle [1,3,5,2])</span>
<a name="line-375"></a><span class='hs-comment'>--   &gt;            # showOrigin</span>
<a name="line-376"></a><span class='hs-comment'>--   &gt;            # frame 0.5</span>
<a name="line-377"></a><span class='hs-comment'>--</span>
<a name="line-378"></a><span class='hs-comment'>--   &lt;&lt;diagrams/src_Diagrams_Combinators_alignedEx2.svg#diagram=alignedEx2&amp;width=400&gt;&gt;</span>
<a name="line-379"></a><span class='hs-comment'>--</span>
<a name="line-380"></a><span class='hs-comment'>--   &gt; alignedEx2 = (mconcat # composeAligned alignTL) [circle 1, square 1, triangle 1, pentagon 1]</span>
<a name="line-381"></a><span class='hs-comment'>--   &gt;            # showOrigin</span>
<a name="line-382"></a><span class='hs-comment'>--   &gt;            # frame 0.1</span>
<a name="line-383"></a><span class='hs-definition'>composeAligned</span>
<a name="line-384"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monoid'</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Floating</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>Metric</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-385"></a>  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- ^ Alignment function</span>
<a name="line-386"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ Composition function</span>
<a name="line-387"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QDiagram</span> <span class='hs-varid'>b</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-388"></a><span class='hs-definition'>composeAligned</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>combine</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>combine</span> <span class='hs-conid'>[]</span>
<a name="line-389"></a><span class='hs-definition'>composeAligned</span> <span class='hs-varid'>algn</span> <span class='hs-varid'>comb</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>comb</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>algn</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-cpp'>#</span> <span class='hs-varid'>moveOriginTo</span> <span class='hs-varid'>l</span>
<a name="line-390"></a>  <span class='hs-keyword'>where</span>
<a name="line-391"></a>    <span class='hs-varid'>mss</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span> <span class='hs-varop'>.&gt;&gt;</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- qualify first to avoid stomping on an existing () name</span>
<a name="line-392"></a>          <span class='hs-cpp'>#</span> <span class='hs-varid'>named</span> <span class='hs-conid'>()</span>     <span class='hs-comment'>-- Mark the origin</span>
<a name="line-393"></a>          <span class='hs-cpp'>#</span> <span class='hs-varid'>algn</span>         <span class='hs-comment'>-- Apply the alignment function</span>
<a name="line-394"></a>          <span class='hs-layout'>)</span>
<a name="line-395"></a>          <span class='hs-comment'>-- then find out what happened to the origin</span>
<a name="line-396"></a>        <span class='hs-varop'>^.</span> <span class='hs-varid'>subMap</span> <span class='hs-varop'>.</span> <span class='hs-sel'>_Wrapped</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Lens</span><span class='hs-varop'>.</span><span class='hs-varid'>at</span> <span class='hs-layout'>(</span><span class='hs-varid'>toName</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-397"></a>    <span class='hs-varid'>l</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>location</span> <span class='hs-varop'>.</span> <span class='hs-varid'>head</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromJust</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mss</span>
<a name="line-398"></a>          <span class='hs-comment'>-- the fromJust is Justified since we put the () name in</span>
</pre></body>
</html>
