<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Diagrams/Util.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- |</span>
<a name="line-3"></a><span class='hs-comment'>-- Module      :  Diagrams.Util</span>
<a name="line-4"></a><span class='hs-comment'>-- Copyright   :  (c) 2011-2015 diagrams-lib team (see LICENSE)</span>
<a name="line-5"></a><span class='hs-comment'>-- License     :  BSD-style (see LICENSE)</span>
<a name="line-6"></a><span class='hs-comment'>-- Maintainer  :  diagrams-discuss@googlegroups.com</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- Some miscellaneous utilities provided by the diagrams-lib package.</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Diagrams</span><span class='hs-varop'>.</span><span class='hs-conid'>Util</span>
<a name="line-13"></a>  <span class='hs-layout'>(</span> <span class='hs-comment'>-- * Utilities for users</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-varid'>with</span>
<a name="line-16"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>applyAll</span>
<a name="line-17"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-cpp'>##</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>iterateN</span>
<a name="line-21"></a>
<a name="line-22"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tau</span>
<a name="line-23"></a>
<a name="line-24"></a>    <span class='hs-comment'>-- * Finding files</span>
<a name="line-25"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>findHsFile</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-comment'>-- * Finding sandboxes</span>
<a name="line-28"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>findSandbox</span>
<a name="line-29"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>globalPackage</span>
<a name="line-30"></a>
<a name="line-31"></a>    <span class='hs-comment'>-- * Internal utilities</span>
<a name="line-32"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>foldB</span>
<a name="line-33"></a>
<a name="line-34"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-37"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Lens</span>              <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span> <span class='hs-cpp'>#</span> <span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-39"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Catch</span>
<a name="line-40"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span>
<a name="line-41"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-42"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Default</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-43"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-44"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-varop'>.</span><span class='hs-conid'>Lens</span>
<a name="line-45"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-46"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Monoid</span>
<a name="line-47"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Directory</span>
<a name="line-48"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Environment</span>
<a name="line-49"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span>
<a name="line-50"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span><span class='hs-varop'>.</span><span class='hs-conid'>Lens</span>
<a name="line-51"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Process</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="with"></a><span class='hs-comment'>-- | Several functions exported by the diagrams library take a number</span>
<a name="line-54"></a><span class='hs-comment'>--   of arguments giving the user control to \"tweak\" various aspects</span>
<a name="line-55"></a><span class='hs-comment'>--   of their behavior.  Rather than give such functions a long list</span>
<a name="line-56"></a><span class='hs-comment'>--   of arguments, and to make it possible for the user to selectively</span>
<a name="line-57"></a><span class='hs-comment'>--   override only certain arguments and use default values for</span>
<a name="line-58"></a><span class='hs-comment'>--   others, such sets of arguments are collected into a record with</span>
<a name="line-59"></a><span class='hs-comment'>--   named fields (see 'PolygonOpts' in "Diagrams.TwoD.Shapes" for an</span>
<a name="line-60"></a><span class='hs-comment'>--   example).  Such record types are made instances of the 'Default'</span>
<a name="line-61"></a><span class='hs-comment'>--   class, which provides a single record structure ('def')</span>
<a name="line-62"></a><span class='hs-comment'>--   collecting the \"default\" arguments to the function.  @with@ is</span>
<a name="line-63"></a><span class='hs-comment'>--   a synonym for 'def', which provides nice-looking syntax for</span>
<a name="line-64"></a><span class='hs-comment'>--   simulating optional, named arguments in Haskell.  For example,</span>
<a name="line-65"></a><span class='hs-comment'>--</span>
<a name="line-66"></a><span class='hs-comment'>--   @</span>
<a name="line-67"></a><span class='hs-comment'>--   polygon with {sides = 7, edgeSkip = 2}</span>
<a name="line-68"></a><span class='hs-comment'>--   @</span>
<a name="line-69"></a><span class='hs-comment'>--</span>
<a name="line-70"></a><span class='hs-comment'>--   calls the 'polygon' function with a single argument (note that</span>
<a name="line-71"></a><span class='hs-comment'>--   record update binds more tightly than function application!),</span>
<a name="line-72"></a><span class='hs-comment'>--   namely, 'with' (the record of default arguments) where the</span>
<a name="line-73"></a><span class='hs-comment'>--   @sides@ and @edgeSkip@ fields have been updated.</span>
<a name="line-74"></a><span class='hs-definition'>with</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Default</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>d</span>
<a name="line-75"></a><span class='hs-definition'>with</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>def</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="applyAll"></a><span class='hs-comment'>-- | @applyAll@ takes a list of functions and applies them all to a</span>
<a name="line-78"></a><span class='hs-comment'>--   value, in sequence from the last function in the list to the first.</span>
<a name="line-79"></a><span class='hs-comment'>--   For example, @applyAll [f1, f2, f3] a == f1 . f2 . f3 $ a@.</span>
<a name="line-80"></a><span class='hs-definition'>applyAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-81"></a><span class='hs-definition'>applyAll</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appEndo</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mconcat</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Endo</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-keyword'>infixl</span> <span class='hs-num'>8</span> <span class='hs-cpp'>#</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-comment'>-- | Postfix function application, for conveniently applying</span>
<a name="line-86"></a><span class='hs-comment'>--   attributes.  Unlike @($)@, @(#)@ has a high precedence (8), so @d</span>
<a name="line-87"></a><span class='hs-comment'>--   \# foo \# bar@ can be combined with other things using operators</span>
<a name="line-88"></a><span class='hs-comment'>--   like @(|||)@ or @(\&lt;\&gt;)@ without needing parentheses.</span>
<a name="line-89"></a><span class='hs-layout'>(</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-90"></a><span class='hs-layout'>(</span><span class='hs-cpp'>#</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-comment'>-- | A replacement for lenses' 'Control.Lens.Review.#' operator.</span>
<a name="line-93"></a><span class='hs-layout'>(</span><span class='hs-cpp'>##</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AReview</span> <span class='hs-varid'>t</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>t</span>
<a name="line-94"></a><span class='hs-layout'>(</span><span class='hs-cpp'>##</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>review</span>
<a name="line-95"></a><span class='hs-comment'>{-# INLINE (##) #-}</span>
<a name="line-96"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>8</span> <span class='hs-cpp'>##</span>
<a name="line-97"></a>
<a name="line-98"></a>
<a name="line-99"></a><a name="iterateN"></a><span class='hs-comment'>-- | @iterateN n f x@ returns the list of the first @n@ iterates of</span>
<a name="line-100"></a><span class='hs-comment'>--   @f@ starting at @x@, that is, the list @[x, f x, f (f x), ...]@</span>
<a name="line-101"></a><span class='hs-comment'>--   of length @n@. (Note that the last element of the list will be</span>
<a name="line-102"></a><span class='hs-comment'>--   @f@ applied to @x@ @(n-1)@ times.)</span>
<a name="line-103"></a><span class='hs-definition'>iterateN</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-104"></a><span class='hs-definition'>iterateN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>take</span> <span class='hs-varid'>n</span> <span class='hs-varop'>.</span> <span class='hs-varid'>iterate</span> <span class='hs-varid'>f</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="tau"></a><span class='hs-comment'>-- | The circle constant, the ratio of a circle's circumference to its</span>
<a name="line-107"></a><span class='hs-comment'>--   /radius/.  Note that @pi = tau/2@.</span>
<a name="line-108"></a><span class='hs-comment'>--</span>
<a name="line-109"></a><span class='hs-comment'>--   For more information and a well-reasoned argument why we should</span>
<a name="line-110"></a><span class='hs-comment'>--   all be using tau instead of pi, see /The Tau Manifesto/,</span>
<a name="line-111"></a><span class='hs-comment'>--   &lt;<a href="http://tauday.com/">http://tauday.com/</a>&gt;.</span>
<a name="line-112"></a><span class='hs-comment'>--</span>
<a name="line-113"></a><span class='hs-comment'>--   To hear what it sounds like (and to easily memorize the first 30</span>
<a name="line-114"></a><span class='hs-comment'>--   digits or so), try &lt;<a href="http://youtu.be/3174T-3-59Q">http://youtu.be/3174T-3-59Q</a>&gt;.</span>
<a name="line-115"></a><span class='hs-definition'>tau</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Floating</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span>
<a name="line-116"></a><span class='hs-definition'>tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span><span class='hs-varop'>*</span><span class='hs-varid'>pi</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="foldB"></a><span class='hs-comment'>-- | Given an associative binary operation and a default value to use</span>
<a name="line-119"></a><span class='hs-comment'>--   in the case of an empty list, perform a /balanced/ fold over a</span>
<a name="line-120"></a><span class='hs-comment'>--   list.  For example,</span>
<a name="line-121"></a><span class='hs-comment'>--</span>
<a name="line-122"></a><span class='hs-comment'>--   @</span>
<a name="line-123"></a><span class='hs-comment'>--   foldB (+) z [a,b,c,d,e,f] == ((a+b) + (c+d)) + (e+f)</span>
<a name="line-124"></a><span class='hs-comment'>--   @</span>
<a name="line-125"></a><span class='hs-comment'>--</span>
<a name="line-126"></a><span class='hs-definition'>foldB</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-127"></a><span class='hs-definition'>foldB</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>z</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span>
<a name="line-128"></a><span class='hs-definition'>foldB</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldB'</span> <span class='hs-keyword'>as</span>
<a name="line-129"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>foldB'</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-130"></a>        <span class='hs-varid'>foldB'</span> <span class='hs-varid'>xs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldB'</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-131"></a>        <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-132"></a>        <span class='hs-varid'>go</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
<a name="line-133"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>x1</span><span class='hs-conop'>:</span><span class='hs-varid'>x2</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x1</span> <span class='hs-varid'>x2</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>xs</span>
<a name="line-134"></a>
<a name="line-135"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-136"></a><span class='hs-comment'>-- Files</span>
<a name="line-137"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="findHsFile"></a><span class='hs-comment'>-- | Given some file (no extension or otherwise) try to find a haskell</span>
<a name="line-140"></a><span class='hs-comment'>--   source file.</span>
<a name="line-141"></a><span class='hs-definition'>findHsFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-142"></a><span class='hs-definition'>findHsFile</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMaybeT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hs</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>lhs</span>
<a name="line-143"></a>  <span class='hs-keyword'>where</span>
<a name="line-144"></a>    <span class='hs-varid'>hs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-varid'>addExtension</span> <span class='hs-varid'>file</span> <span class='hs-str'>"hs"</span><span class='hs-layout'>)</span>
<a name="line-145"></a>    <span class='hs-varid'>lhs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-varid'>addExtension</span> <span class='hs-varid'>file</span> <span class='hs-str'>"lhs"</span><span class='hs-layout'>)</span>
<a name="line-146"></a>    <span class='hs-varid'>check</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-147"></a>      <span class='hs-varid'>lift</span> <span class='hs-layout'>(</span><span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>guard</span>
<a name="line-148"></a>      <span class='hs-varid'>pure</span> <span class='hs-varid'>f</span>
<a name="line-149"></a>
<a name="line-150"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-151"></a><span class='hs-comment'>-- Sandbox</span>
<a name="line-152"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-153"></a>
<a name="line-154"></a><a name="parseConfig"></a><span class='hs-comment'>-- | Parse cabal config file to find the location of the package</span>
<a name="line-155"></a><span class='hs-comment'>--   database.</span>
<a name="line-156"></a><span class='hs-definition'>parseConfig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeT</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-157"></a><span class='hs-definition'>parseConfig</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-158"></a>  <span class='hs-varid'>config</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readFile</span> <span class='hs-varid'>file</span>
<a name="line-159"></a>  <span class='hs-varid'>hoistMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>config</span> <span class='hs-varop'>^?</span> <span class='hs-varid'>lined</span> <span class='hs-varop'>.</span> <span class='hs-varid'>prefixed</span> <span class='hs-str'>"package-db: "</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="configSearch"></a><span class='hs-comment'>-- | Seach the given directory and all parent directories until a cabal</span>
<a name="line-162"></a><span class='hs-comment'>--   config file is found. First search for \"cabal.config\", then</span>
<a name="line-163"></a><span class='hs-comment'>--   \"cabal.sandbox.config\". Return the location of the package</span>
<a name="line-164"></a><span class='hs-comment'>--   database in the config file.</span>
<a name="line-165"></a><span class='hs-definition'>configSearch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeT</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-166"></a><span class='hs-definition'>configSearch</span> <span class='hs-varid'>p0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-167"></a>  <span class='hs-varid'>p0'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>canonicalizePath</span> <span class='hs-varid'>p0</span>
<a name="line-168"></a>
<a name="line-169"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>mkPaths</span> <span class='hs-varid'>p</span>
<a name="line-170"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>p</span> <span class='hs-varop'>||</span> <span class='hs-varid'>p</span> <span class='hs-varop'>==</span> <span class='hs-str'>"."</span>
<a name="line-171"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-172"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"cabal.sandbox.config"</span><span class='hs-layout'>)</span>
<a name="line-173"></a>                    <span class='hs-conop'>:</span> <span class='hs-varid'>mkPaths</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>^.</span> <span class='hs-varid'>directory</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a>  <span class='hs-varid'>foldMaybeT</span> <span class='hs-varid'>parseConfig</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPaths</span> <span class='hs-varid'>p0'</span><span class='hs-layout'>)</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="isDB"></a><span class='hs-comment'>-- | Check if the folder is a database, or if it contains a database.</span>
<a name="line-178"></a><span class='hs-comment'>--   Returns the database location if it's found.</span>
<a name="line-179"></a><span class='hs-definition'>isDB</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeT</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-180"></a><span class='hs-definition'>isDB</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span>
<a name="line-181"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>isConf</span> <span class='hs-varid'>path</span>
<a name="line-182"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>path</span>
<a name="line-183"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>maybeIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>getDirectoryContents</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>hoistMaybe</span> <span class='hs-varop'>.</span> <span class='hs-varid'>find</span> <span class='hs-varid'>isConf</span>
<a name="line-184"></a>    <span class='hs-keyword'>where</span>
<a name="line-185"></a>      <span class='hs-varid'>isConf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSuffixOf</span> <span class='hs-str'>".conf.d"</span>
<a name="line-186"></a>
<a name="line-187"></a><a name="findSandbox"></a><span class='hs-comment'>-- | Search for a sandbox in the following order:</span>
<a name="line-188"></a><span class='hs-comment'>--</span>
<a name="line-189"></a><span class='hs-comment'>--   * Test given FilePaths if they point directly to a database or</span>
<a name="line-190"></a><span class='hs-comment'>--     contain a cabal config file (or any parent directory containing a</span>
<a name="line-191"></a><span class='hs-comment'>--     config file).</span>
<a name="line-192"></a><span class='hs-comment'>--</span>
<a name="line-193"></a><span class='hs-comment'>--   * Same test for @DIAGRAMS_SANDBOX@ environment value</span>
<a name="line-194"></a><span class='hs-comment'>--</span>
<a name="line-195"></a><span class='hs-comment'>--   * Environment values of @GHC_PACKAGE_PATH@, @HSENV@ and</span>
<a name="line-196"></a><span class='hs-comment'>--     @PACKAGE_DB_FOR_GHC@ that point to a database.</span>
<a name="line-197"></a><span class='hs-comment'>--</span>
<a name="line-198"></a><span class='hs-comment'>--   * Test for config file (cabal.sandbox.config) in the current</span>
<a name="line-199"></a><span class='hs-comment'>--     directory and its parents.</span>
<a name="line-200"></a><span class='hs-comment'>--</span>
<a name="line-201"></a><span class='hs-definition'>findSandbox</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-202"></a><span class='hs-definition'>findSandbox</span> <span class='hs-varid'>paths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMaybeT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pathsTest</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>diaSB</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>envDB</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>wdConfig</span>
<a name="line-203"></a>  <span class='hs-keyword'>where</span>
<a name="line-204"></a>    <span class='hs-comment'>-- first path in environment</span>
<a name="line-205"></a>    <span class='hs-varid'>lookEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fmap</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varop'>.</span> <span class='hs-varid'>splitSearchPath</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lookupEnv</span>
<a name="line-206"></a>    <span class='hs-varid'>envDB</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldMaybeT</span> <span class='hs-varid'>lookEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"GHC_PACKAGE_PATH"</span><span class='hs-layout'>,</span> <span class='hs-str'>"HSENV"</span><span class='hs-layout'>,</span> <span class='hs-str'>"PACKAGE_DB_FOR_GHC"</span><span class='hs-keyglyph'>]</span>
<a name="line-207"></a>
<a name="line-208"></a>    <span class='hs-comment'>-- test if path points directly to db or contains a config file</span>
<a name="line-209"></a>    <span class='hs-varid'>test</span> <span class='hs-varid'>x</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDB</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>configSearch</span> <span class='hs-varid'>x</span>
<a name="line-210"></a>    <span class='hs-varid'>pathsTest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldMaybeT</span> <span class='hs-varid'>test</span> <span class='hs-varid'>paths</span>
<a name="line-211"></a>    <span class='hs-varid'>diaSB</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookEnv</span> <span class='hs-str'>"DIAGRAMS_SANDBOX"</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>test</span>
<a name="line-212"></a>    <span class='hs-varid'>wdConfig</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeIO</span> <span class='hs-varid'>getCurrentDirectory</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>configSearch</span>
<a name="line-213"></a>
<a name="line-214"></a><span class='hs-comment'>-- -- | Use the given path for the sandbox in the @GHC_PACKAGE_PATH@</span>
<a name="line-215"></a><span class='hs-comment'>-- --   environment (appending the ghc global package database from @ghc</span>
<a name="line-216"></a><span class='hs-comment'>-- --   --info@. @GHC_PACKAGE_PATH@ if the variable ghc and other tools use</span>
<a name="line-217"></a><span class='hs-comment'>-- --   to find the package database. (This is what @cabal exec@ sets)</span>
<a name="line-218"></a><span class='hs-comment'>-- ghcPackagePath :: FilePath -&gt; IO ()</span>
<a name="line-219"></a><span class='hs-comment'>-- ghcPackagePath db = do</span>
<a name="line-220"></a><span class='hs-comment'>--   gdb &lt;- globalPackage</span>
<a name="line-221"></a><span class='hs-comment'>--   let dbs = intercalate [searchPathSeparator] [db,gdb]</span>
<a name="line-222"></a><span class='hs-comment'>--   setEnv "GHC_PACKAGE_PATH" dbs</span>
<a name="line-223"></a><span class='hs-comment'>-- -- setEnv is only in base &gt; 4.7, either need to use setenv package or</span>
<a name="line-224"></a><span class='hs-comment'>-- -- -package-db flag</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="globalPackage"></a><span class='hs-comment'>-- | Find ghc's global package database. Throws an error if it isn't</span>
<a name="line-227"></a><span class='hs-comment'>--   found.</span>
<a name="line-228"></a><span class='hs-definition'>globalPackage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-229"></a><span class='hs-definition'>globalPackage</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-230"></a>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>read</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>readProcess</span> <span class='hs-str'>"ghc"</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"--info"</span><span class='hs-keyglyph'>]</span> <span class='hs-str'>""</span>
<a name="line-231"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-str'>"Unable to parse ghc --info."</span><span class='hs-layout'>)</span>
<a name="line-232"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>lookup</span> <span class='hs-str'>"Global Package DB"</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-233"></a>
<a name="line-234"></a><span class='hs-comment'>-- MaybeT utilities</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="maybeIO"></a><span class='hs-comment'>-- | Lift an 'IO' action. If any exceptions are raised, return Nothing.</span>
<a name="line-237"></a><span class='hs-definition'>maybeIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadCatch</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-238"></a><span class='hs-definition'>maybeIO</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>io</span> <span class='hs-varop'>`catchAll`</span> <span class='hs-varid'>const</span> <span class='hs-varid'>mzero</span>
<a name="line-239"></a>
<a name="line-240"></a><a name="hoistMaybe"></a><span class='hs-comment'>-- | Lift a maybe value to a MaybeT of any monad.</span>
<a name="line-241"></a><span class='hs-definition'>hoistMaybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-242"></a><span class='hs-definition'>hoistMaybe</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varop'>.</span> <span class='hs-varid'>return</span>
<a name="line-243"></a>
<a name="line-244"></a><a name="foldMaybeT"></a><span class='hs-comment'>-- | Fold a list of 'MaybeT's that short-circuits as soon as a Just value</span>
<a name="line-245"></a><span class='hs-comment'>--   is found (instead going through the whole list).</span>
<a name="line-246"></a><span class='hs-definition'>foldMaybeT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varid'>m</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varid'>m</span> <span class='hs-varid'>b</span>
<a name="line-247"></a><span class='hs-definition'>foldMaybeT</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mzero</span>
<a name="line-248"></a><span class='hs-definition'>foldMaybeT</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-249"></a>  <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMaybeT</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-250"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>x</span>
<a name="line-251"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>
<a name="line-252"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>runMaybeT</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldMaybeT</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-253"></a>
</pre></body>
</html>
